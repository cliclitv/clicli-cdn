<html>

<head>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js"></script>
</head>

<body>
    <div>
        <section>
            文件上传
        </section>
        <div style="text-align:center;margin: 50px auto;">
            <form id="upForm" action="#" method="post" enctype="multipart/form-data">
                <input id="file" type="file" name="file" style="display:none" />
                <label for="file">选择文件</label>
            </form>
        </div>
        <div id="output"></div>
    </div>
</body>

<style>
    * {
        padding: 0;
        margin: 0;
    }

    label {
        background: #946ce6;
        border-radius: 10px;
        color: #fff;
        display: block;
        padding: 20px;
        width: 200px;
        margin: 100px auto;
        cursor: pointer;
    }

    body {
        text-align: center;
    }

    section {
        padding: 20px;
        background: #946ce6;
        color: #fff;
    }

    #output {
        padding: 10px;
        background: #f1eaff;
        color: #946ce6;
        border: 2px solid #946ce6;
        margin: 20px;
        border-radius: 10px;
    }

    /* input[type=file]{
        background: #946ce6;
        color: #fff;
        border-radius: 50px;
        border: none;
    } */
</style>

<script lang="javascript">

    document.querySelector('#file').addEventListener('change', event => {
        handleImageUpload(event)
    })

    const o = document.querySelector('#output')

    o.textContent = '还没上传'

    const sliceFile = (file) => {
        const size = 1024 * 1024 * 5;
        const total = file.size;
        let out = []

        for (i = 0; i < total; i += size) {
            const s = file.slice(i, i + size)
            console.log(s)
            out.push(s)
        }
        return out
    }


    let id = Math.floor(Math.random() * 9) + 1;
    let host = window.location.origin

    const handleImageUpload = event => {
        const files = event.target.files
        // 需要先切片
        const chunks = sliceFile(files[0])

        let queue = []

        chunks.forEach((chunk, index) => {
            queue.push(() => uploadChunk(chunk, index))
        })

        queue.push(combineChunk)

        function combineChunk() {
            return new Promise(r => {
                fetch(window.location.pathname + window.location.search, {
                    method: 'POST',
                    body: JSON.stringify({
                        id: id.toString(),
                        name: files[0].name
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => res.json()).then(data => {
                    o.textContent = `https://cdn.clicli.cc/video/${data.msg.replace('.mp4', '/index.m3u8')}`
                    r()
                })
            })

        }

        function uploadChunk(chunk, index) {
            console.log(index)
            const formData = new FormData()
            formData.append('id', id)
            formData.append('num', index + 1)
            formData.append('total', files[0].size)
            formData.append('size', 1024 * 1024 * 5)
            formData.append('name', files[0].name)
            formData.append('data', chunk)

            const url = `${host}/chunk`

            return new Promise(r => {
                axios
                    .post(url, formData, {
                        headers: { "Content-Type": "multipart/form-data" },
                    })
                    .then(function (res) {
                        o.textContent = `视频分块上传中（${index + 1}/${chunks.length}）`
                        r(index)

                    })
            })

        }

        // 最后发一个合并请求即可

        o.textContent = `视频分块上传中（0/${chunks.length}）`

        queue.reduce((cur, next) => {
            return cur.then(next);
        }, Promise.resolve());

    }
</script>

</html>